<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }} — Linglong</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}" />
  </head>

  <body class="challenge-page">
    <div class="challenge-aura">
      <span class="challenge-aura__label">AURA</span>
      <div class="challenge-aura__bar"><div class="challenge-aura__fill" id="auraFill"></div></div>
      <span class="challenge-aura__score" id="auraScore">0/8</span>
    </div>

    <div class="challenge-video-wrap" id="videoWrap">
      <div class="challenge-video-placeholder" id="videoPlaceholder">
        <h2 class="challenge-intro__title">Beat-Pause Challenge</h2>
        <p class="challenge-intro__text">The video will pause on each beat. Pick the correct Indonesian word to keep the rhythm going!</p>
        <button type="button" class="onboarding-btn onboarding-btn--primary" id="startBeatBtn">START THE BEAT</button>
      </div>
      <div class="challenge-say-the-word" id="sayTheWordIntro" aria-hidden="true" style="display: none;">
        <h2 class="challenge-say-the-word__title">SAY THE WORD!</h2>
        <p class="challenge-say-the-word__sub" id="sayTheWordCountdown">Get ready...</p>
      </div>
      <div class="challenge-video-area challenge-video-area--ratio" id="videoArea" hidden>
        <video id="challengeVideo" class="challenge-video-iframe" src="{{ url_for('static', filename='video/brainrot.mp4') }}" preload="auto" playsinline></video>
      </div>
    </div>

    <div class="challenge-popup" id="questionPopup" hidden>
      <div class="challenge-popup__backdrop"></div>
      <div class="challenge-popup__box">
        <h3 class="challenge-popup__title" id="questionTitle">SAY THE WORD!</h3>
        <div class="challenge-popup__options" id="questionOptions"></div>
      </div>
    </div>

    <div class="challenge-mascot">
      <img src="{{ url_for('static', filename='linglong/neutral.png') }}" alt="Linglong" />
    </div>

    <script>
      (function () {
        // ========== CONFIG ==========
        var totalQuestions = 8;
        var questions = [
          { word: "Buku", correct: "BUKU", options: ["BUKU", "Saku", "Palu", "Lampu"] },
          { word: "Saku", correct: "SAKU", options: ["Buku", "SAKU", "Ikan", "Makan"] },
          { word: "Palu", correct: "PALU", options: ["Hutan", "PALU", "Jalan", "Lampu"] },
          { word: "Lampu", correct: "LAMPU", options: ["Buku", "Saku", "PALU", "LAMPU"] },
          { word: "Ikan", correct: "IKAN", options: ["IKAN", "Makan", "Jalan", "Hutan"] },
          { word: "Hutan", correct: "HUTAN", options: ["Buku", "HUTAN", "Palu", "Saku"] },
          { word: "Makan", correct: "MAKAN", options: ["Ikan", "MAKAN", "Jalan", "Lampu"] },
          { word: "Jalan", correct: "JALAN", options: ["JALAN", "Buku", "Hutan", "Makan"] }
        ];
      
        // BEATS TIMESTAMPS (adjusted for 28s video)
        var beats = [
          { time: 26.0, word: 'Buku' },
          { time: 26.3, word: 'Saku' },
          { time: 26.6, word: 'Palu' },
          { time: 26.9, word: 'Lampu' },
          { time: 27.2, word: 'Ikan' },
          { time: 27.5, word: 'Hutan' },
          { time: 27.8, word: 'Makan' },
          { time: 28.1, word: 'Jalan' }
        ]
        // ========== STATE ==========
        var currentQ = 0;                     // index into beats/questions
        var correctCount = 0;
        var wrongCount = 0;
        var resultPerQuestion = [];
        var videoReady = false;                // track if video metadata loaded & seeked
        var challengeActive = false;            // whether game has started (post-countdown)
        var rafId = null;                      // requestAnimationFrame id
        var triggeredBeats = new Array(beats.length).fill(false); // track per-beat trigger
        var video = document.getElementById("challengeVideo");
        var videoWrap = document.getElementById("videoWrap");
        var videoPlaceholder = document.getElementById("videoPlaceholder");
        var sayTheWordIntro = document.getElementById("sayTheWordIntro");
        var countdownEl = document.getElementById("sayTheWordCountdown");
        var videoArea = document.getElementById("videoArea");
        var questionPopup = document.getElementById("questionPopup");
        var questionTitle = document.getElementById("questionTitle");
        var questionOptions = document.getElementById("questionOptions");
        var auraFill = document.getElementById("auraFill");
        var auraScore = document.getElementById("auraScore");
        var startBtn = document.getElementById("startBeatBtn");
      
        // ========== HELPER FUNCTIONS ==========
        function updateAura() {
          var pct = (correctCount / totalQuestions) * 100;
          if (auraFill) auraFill.style.height = pct + "%";
          if (auraScore) auraScore.textContent = correctCount + "/" + totalQuestions;
        }
      
        // Show question popup for current beat
        function showQuestion() {
          if (currentQ >= totalQuestions) {
            // End of challenge – save results and redirect
            try {
              sessionStorage.setItem("challenge_correct", String(correctCount));
              sessionStorage.setItem("challenge_wrong", String(wrongCount));
              sessionStorage.setItem("challenge_words", JSON.stringify(questions.map(function (q) { return q.word; })));
              sessionStorage.setItem("challenge_results", JSON.stringify(resultPerQuestion));
            } catch (e) {}
            window.location.href = "{{ url_for('pages.challenge_result') }}";
            return;
          }
      
          var q = questions[currentQ]; // questions aligned with beats[currentQ]
          questionTitle.textContent = "SAY THE WORD!";
          questionOptions.innerHTML = "";
      
          q.options.forEach(function (opt) {
            var btn = document.createElement("button");
            btn.type = "button";
            btn.className = "challenge-popup__option";
            btn.textContent = opt;
            btn.addEventListener("click", function () {
              var isCorrect = opt === q.correct;
              if (isCorrect) {
                correctCount++;
                btn.classList.add("challenge-popup__option--correct");
              } else {
                wrongCount++;
                btn.classList.add("challenge-popup__option--wrong");
              }
              resultPerQuestion.push(isCorrect);
              updateAura();
      
              // Mark this beat as triggered so we don't pause again
              if (currentQ < triggeredBeats.length) {
                triggeredBeats[currentQ] = true;
              }
      
              // Hide popup, then resume video
              questionPopup.hidden = true;
              video.play().catch(function(e) {
                console.log("Play after answer failed:", e);
              });
      
              // Move to next question index (will be used when next beat hits)
              currentQ++;
              console.log("Current Question Index: ", currentQ);
            });
            questionOptions.appendChild(btn);
          });
      
          // Show popup
          if (questionPopup) {
            questionPopup.hidden = false;
            questionPopup.style.display = "";
          }
        }
      
        // requestAnimationFrame loop to check video time precisely
function timeUpdateLoop() {
  if (!challengeActive || !video || video.paused || video.ended || !videoReady) {
    rafId = requestAnimationFrame(timeUpdateLoop);
    return;
  }

  var currentTime = video.currentTime;
  
  // Check if we've reached the next beat (simple greater-than check)
  if (currentQ < beats.length && !triggeredBeats[currentQ] && currentTime >= beats[currentQ].time) {
    // Pause video
    video.pause();

    // Mark triggered
    triggeredBeats[currentQ] = true;
    
    // Show question
    showQuestion();
    
    rafId = requestAnimationFrame(timeUpdateLoop);
    return;
  }

  rafId = requestAnimationFrame(timeUpdateLoop);
}
      
        // Initialize video: seek to 26s and wait until ready
        function setupVideoAndStart() {
          if (!video) {
            console.error("Video element not found");
            showQuestion(); // fallback
            return;
          }
      
          // Ensure video attributes
          video.playsInline = true;
          video.muted = false;      // unmute – let audio play
          video.controls = false;
          video.preload = "auto";
      
          // Function to seek and wait for readyState
          function seekToStart() {
            video.currentTime = 10.0; // forced seek to 26s
      
            // Wait for video to be ready (HAVE_FUTURE_DATA = 3)
            var checkReady = setInterval(function() {
              if (video.readyState >= 3) { // HAVE_FUTURE_DATA or more
                clearInterval(checkReady);
                videoReady = true;
                // Now show video and start the game
                if (videoArea) videoArea.hidden = false;
                video.play().then(function() {
                  console.log("Video started at:", video.currentTime);
                  console.log("First beat time:", beats[0].time);
                  
                  // Add a one-time check after 5 seconds
                  setTimeout(function() {
                    console.log("Current time after 5s:", video.currentTime);
                    console.log("CurrentQ:", currentQ, "Triggered:", triggeredBeats[currentQ]);
                  }, 5000);

                  // Handle video end
                  video.addEventListener('ended', function onVideoEnd() {
                    console.log("Video ended, currentQ:", currentQ, "totalQuestions:", totalQuestions);
                    
                    // Remove the listener to avoid duplicates
                    video.removeEventListener('ended', onVideoEnd);
                    
                    if (currentQ >= totalQuestions) {
                      // All questions answered, save results and redirect
                      try {
                        sessionStorage.setItem("challenge_correct", String(correctCount));
                        sessionStorage.setItem("challenge_wrong", String(wrongCount));
                        sessionStorage.setItem("challenge_words", JSON.stringify(questions.map(function (q) { return q.word; })));
                        sessionStorage.setItem("challenge_results", JSON.stringify(resultPerQuestion));
                      } catch (e) {}
                      
                      // Redirect to results page
                      window.location.href = "{{ url_for('pages.challenge_result') }}";
                    } else {
                      // Video ended early - maybe restart or handle differently
                      console.log("Video ended before all questions were answered");
                      // You could restart from beginning or just redirect anyway
                      window.location.href = "{{ url_for('pages.challenge_result') }}";
                    }
                  });

                  // Start the animation loop
                  challengeActive = true;
                  if (!rafId) {
                    rafId = requestAnimationFrame(timeUpdateLoop);
                  }
                }).catch(function(e) {
                  console.log("Play after seek failed:", e);
                  // fallback – start questions anyway
                  showQuestion();
                });
              }
            }, 50); // check every 50ms
          }
      
          // If metadata already loaded, seek now
          if (video.readyState >= 1) {
            seekToStart();
          } else {
            // Wait for metadata
            video.addEventListener('loadedmetadata', function onMeta() {
              video.removeEventListener('loadedmetadata', onMeta);
              seekToStart();
            });
          }
        }
      
        // Start the countdown and then boot video
        function startChallenge() {
          // Hide placeholder
          videoPlaceholder.hidden = true;
      
          // Show SAY THE WORD! countdown
          if (sayTheWordIntro) {
            sayTheWordIntro.style.display = "";
            sayTheWordIntro.setAttribute("aria-hidden", "false");
      
            var countdown = 3;
            if (countdownEl) countdownEl.textContent = "Starting in " + countdown + "...";
      
            var tick = setInterval(function () {
              countdown -= 1;
              if (countdownEl) {
                countdownEl.textContent = countdown > 0 ? "Starting in " + countdown + "..." : "Go!";
              }
              if (countdown <= 0) {
                clearInterval(tick);
                // Hide intro
                sayTheWordIntro.style.display = "none";
                sayTheWordIntro.setAttribute("aria-hidden", "true");
                // Now set up video (seek to 26s, wait for ready, play)
                setupVideoAndStart();
              }
            }, 1000);
          } else {
            // No intro element – go straight to video
            setupVideoAndStart();
          }
        }
      
        // ========== EVENT LISTENERS ==========
        if (startBtn) {
          startBtn.addEventListener("click", startChallenge);
        }
      
        // Clean up RAF on page unload
        window.addEventListener('beforeunload', function() {
          if (rafId) {
            cancelAnimationFrame(rafId);
          }
        });
      
        // Initial aura update
        updateAura();
      
        // Ensure video element has correct attributes (they are set in HTML too)
        if (video) {
          video.setAttribute('playsinline', '');
          video.setAttribute('preload', 'auto');
          video.muted = false;
          video.controls = false;
        }
      
      })();
      </script>
  </body>
</html>
